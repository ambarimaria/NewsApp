@model HeadlinesViewModel
@{
    ViewData["Title"] = System.Globalization.CultureInfo.CurrentCulture.TextInfo.ToTitleCase(Model.SelectedCategory) + " Headlines";
    ViewData["ActivePage"] = "Headlines";
    ViewData["ActiveCategory"] = Model.SelectedCategory;
    var routeValues = new Dictionary<string, string?> { ["category"]=Model.SelectedCategory, ["country"]=Model.SelectedCountry };
    var featured  = Model.Articles.FirstOrDefault();
    var secondary = Model.Articles.Skip(1).Take(2).ToList();
    var gridItems = Model.Articles.Skip(3).ToList();
    bool showHero = Model.Pagination.CurrentPage == 1 && featured != null;
    string D(NewsApp.Models.ViewModels.Article a) =>
        $"/News/Detail?url={Uri.EscapeDataString(a.Url)}&title={Uri.EscapeDataString(a.Title)}" +
        $"&description={Uri.EscapeDataString(a.Description??"")}" +
        $"&image={Uri.EscapeDataString(a.ImageUrl??"")}" +
        $"&author={Uri.EscapeDataString(a.DisplayAuthor)}" +
        $"&source={Uri.EscapeDataString(a.SourceName)}" +
        $"&publishedAt={Uri.EscapeDataString(a.PublishedAt?.ToString("o")??"" )}";
}

<!-- Page Header -->
<div class="headlines-header fade-up">
    <div>
        <h1 class="headlines-title">
            <span class="hl-category">@System.Globalization.CultureInfo.CurrentCulture.TextInfo.ToTitleCase(Model.SelectedCategory)</span> Headlines
        </h1>
        <div class="headlines-subtitle">
            <i class="fas fa-globe" style="color:var(--accent);font-size:.65rem"></i>
            <span>@Model.CountryDisplayName</span>
            @if (Model.Pagination.TotalResults > 0)
            {
                <span style="color:var(--text-faint)">·</span>
                <span>@Model.Pagination.TotalResults.ToString("N0") articles</span>
                <span style="color:var(--text-faint)">·</span>
                <span>Page @Model.Pagination.CurrentPage / @Model.Pagination.TotalPages</span>
            }
            @if (Model.IsFromCache)      { <span class="status-badge cached"><i class="fas fa-bolt"></i>Cached</span> }
            @if (Model.FetchStrategy=="sources") { <span class="status-badge sources"><i class="fas fa-satellite-dish"></i>via Sources</span> }
            @if (Model.FetchStrategy=="search")  { <span class="status-badge search"><i class="fas fa-magnifying-glass"></i>via Search</span> }
        </div>
    </div>
    <form asp-action="Index" method="get">
        <input type="hidden" name="category" value="@Model.SelectedCategory"/>
        <div class="country-select-wrap">
            <label for="csel"><i class="fas fa-globe" style="color:var(--accent)"></i> &nbsp;Country</label>
            <select id="csel" name="country" onchange="this.form.submit()">
                @foreach (var kv in Model.AvailableCountries)
                { 
                    @* <option value="@kv.Key" @(kv.Key==Model.SelectedCountry?"selected":"")>@kv.Value</option>  *@
                    <option value="@kv.Key" selected="@(kv.Key == Model.SelectedCountry)">
                        @kv.Value
                    </option>
                }
            </select>
            <i class="fas fa-chevron-down" style="font-size:.6rem;color:var(--text-faint)"></i>
        </div>
    </form>
</div>

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert-news fade-up mb-4">
        <i class="fas fa-triangle-exclamation"></i>
        <div><strong>Could not load headlines</strong><br/>
             <span style="font-size:.8rem;color:var(--text-muted)">@Model.ErrorMessage</span></div>
    </div>
}

@if (Model.Articles.Any())
{
    <!-- Breaking ticker -->
    @if (Model.Pagination.CurrentPage == 1)
    {
        <div class="ticker-wrap fade-up fade-up-1">
            <span class="ticker-label"><i class="fas fa-bolt me-1"></i>Live</span>
            <div class="ticker-scroll">
                <div class="ticker-track">
                    @foreach (var a in Model.Articles.Take(8))  { <span class="ticker-item">@a.Title</span> }
                    @foreach (var a in Model.Articles.Take(8))  { <span class="ticker-item">@a.Title</span> }
                </div>
            </div>
        </div>
    }

    <!-- Featured Hero -->
    @if (showHero)
    {
        <div class="featured-wrap fade-up fade-up-2">
            <!-- Main feature -->
            <a href="@D(featured!)" class="featured-main">
                @if (featured!.HasImage) {
                    <img class="featured-img" src="@featured.ImageUrl" alt="@featured.Title"
                         onerror="this.style.display='none'"/>
                }
                <div class="featured-gradient"></div>
                <div class="featured-content">
                    <div class="featured-eyebrow">
                        <i class="fas fa-star" style="font-size:.5rem"></i>
                        Featured &nbsp;·&nbsp; @featured.SourceName
                    </div>
                    <h2 class="featured-title">@featured.Title</h2>
                    @if (!string.IsNullOrEmpty(featured.Description))
                    { <p class="featured-desc">@featured.Description</p> }
                    <div class="featured-meta">
                        <span><i class="fas fa-user-pen me-1"></i>@featured.DisplayAuthor</span>
                        <span><i class="far fa-clock me-1"></i>@featured.TimeAgo</span>
                    </div>
                    <span class="featured-read-btn">Read Story <i class="fas fa-arrow-right ms-1"></i></span>
                </div>
            </a>

            <!-- Sidebar stories -->
            <div class="featured-sidebar">
                <div class="featured-sidebar-header">
                    <i class="fas fa-layer-group me-1" style="color:var(--accent)"></i> More Stories
                </div>
                @foreach (var s in secondary)
                {
                    <a href="@D(s)" class="sidebar-story">
                        @if (s.HasImage) {
                            <img class="sidebar-story-img" src="@s.ImageUrl" alt="@s.Title" loading="lazy"
                                 onerror="this.style.display='none'"/>
                        }
                        <div class="sidebar-story-src">@s.SourceName</div>
                        <div class="sidebar-story-title">@s.Title</div>
                        <div class="sidebar-story-time">@s.TimeAgo</div>
                    </a>
                }
            </div>
        </div>
    }

    <!-- Article grid -->
     var grid = showHero ? gridItems : Model.Articles; 
    @if (grid.Any())
    {
        <p class="section-label fade-up fade-up-3">Latest Stories</p>
        <div class="news-grid fade-up fade-up-3">
            @foreach (var a in grid)
            {
                @await Html.PartialAsync("_ArticleCard", a)
            }
        </div>
    }

     ViewData["PaginationRouteValues"]=routeValues; ViewData["PaginationAction"]="Index"; ViewData["PaginationController"]="News";
    @await Html.PartialAsync("_Pagination", Model.Pagination)
}
else if (string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="empty-state fade-up">
        <i class="fas fa-newspaper fa-4x"></i>
        <h4>No headlines found</h4>
        <p>Try a different category or country.</p>
        <a asp-action="Index" asp-route-category="general" asp-route-country="us" class="btn btn-accent mt-3">Reset Filters</a>
    </div>
}

